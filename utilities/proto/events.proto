syntax = "proto3";

package omniql;

option go_package = "github.com/omniql-engine/omniql/utilities/proto";

// ============================================
// ðŸŒ UNIVERSAL QUERY (Supports All Databases)
// ============================================

message UniversalQuery {
    oneof query_type {
        RelationalQuery relational = 1;  // PostgreSQL, MySQL, SQLite
        DocumentQuery document = 2;      // MongoDB
        KeyValueQuery key_value = 3;     // Redis
    }
}

// ============================================
// ðŸŽ¯ EXPRESSION (100% TrueAST - Recursive)
// ============================================

message Expression {
    string type = 1;  // BINARY, FUNCTION, CASEWHEN, FIELD, LITERAL, WINDOW
    int32 position = 2;
    
    // For leaf nodes (FIELD, LITERAL)
    string value = 3;
    
    // For BINARY expressions
    Expression left = 4;
    string operator = 5;
    Expression right = 6;
    
    // For FUNCTION calls
    string function_name = 7;
    repeated Expression function_args = 8;
    
    // For CASEWHEN
    repeated CaseCondition case_conditions = 9;
    Expression case_else = 10;
}

// ============================================
// ðŸ” CONDITION (100% TrueAST)
// ============================================

message QueryCondition {
    Expression field_expr = 1;           // Left side
    string operator = 2;                 // =, !=, >, <, IN, BETWEEN, etc.
    Expression value_expr = 3;           // Right side
    Expression value2_expr = 4;          // For BETWEEN second value
    repeated Expression values_expr = 5; // For IN operator values
    string logic = 6;                    // AND, OR
    repeated QueryCondition nested = 7;  // For parentheses grouping
    int32 position = 8;
}

// ============================================
// ðŸ“ CASE CONDITION (100% TrueAST)
// ============================================

message CaseCondition {
    QueryCondition condition = 1;  // WHEN condition
    Expression then_expr = 2;      // THEN value
    int32 position = 3;
}

// ============================================
// ðŸ“¦ FIELD (100% TrueAST)
// ============================================

message QueryField {
    Expression name_expr = 1;       // Field name
    Expression value_expr = 2;      // Field value
    repeated string constraints = 3; // DDL: UNIQUE, NOT_NULL, PRIMARY_KEY
    int32 position = 4;
}

// ============================================
// ðŸ“Š SELECT COLUMN (100% TrueAST)
// ============================================

message SelectColumn {
    Expression expression_obj = 1;  // The expression
    string alias = 2;               // Optional alias
    int32 position = 3;
}

// ============================================
// ðŸ¦ RELATIONAL QUERY (SQL Databases)
// ============================================

message RelationalQuery {
    string operation = 1;
    string table = 2;
    repeated QueryCondition conditions = 3;
    repeated QueryField fields = 4;
    int32 limit = 5;
    int32 offset = 6;
    bool distinct = 7;
    string transaction_id = 8;
    
    repeated JoinClause joins = 9;
    AggregateClause aggregate = 10;
    repeated Expression group_by = 11;      // 100% TrueAST
    repeated QueryCondition having = 12;
    repeated OrderByClause order_by = 13;
    
    string savepoint_name = 14;
    repeated string permissions = 15;
    string permission_target = 16;
    string role_name = 17;
    
    repeated WindowClause window_functions = 18;
    CTEClause cte = 19;
    SubqueryClause subquery = 20;
    string pattern = 21;
    
    string isolation_level = 22;
    bool read_only = 23;
    
    UpsertClause upsert = 24;
    repeated BulkInsertRow bulk_data = 25;
    
    string view_name = 26;
    RelationalQuery view_query = 27;        // 100% TrueAST
    string database_name = 28;
    string new_name = 29;
    
    string user_name = 30;
    string password = 31;
    repeated string user_roles = 32;
    
    SetOperationClause set_operation = 33;
    repeated Expression columns = 34;        // 100% TrueAST
    repeated SelectColumn select_columns = 35;
    string session_id = 36;
    string sql = 37;
    string alter_action = 38;  // ADD_COLUMN, DROP_COLUMN, RENAME_COLUMN
}

// ============================================
// ðŸ­ DOCUMENT QUERY (MongoDB)
// ============================================

message DocumentQuery {
    string operation = 1;
    string collection = 2;
    repeated QueryCondition conditions = 3;
    repeated QueryField fields = 4;
    int32 limit = 5;
    int32 skip = 6;
    
    repeated JoinClause joins = 7;
    AggregateClause aggregate = 8;
    repeated Expression group_by = 9;        // 100% TrueAST
    repeated OrderByClause order_by = 10;
    
    string savepoint_name = 11;
    repeated string permissions = 12;
    string permission_target = 13;
    string role_name = 14;
    
    repeated WindowClause window_functions = 15;
    string pattern = 16;
    
    string isolation_level = 17;
    bool read_only = 18;
    
    UpsertClause upsert = 19;
    repeated BulkInsertRow bulk_data = 20;
    
    string view_name = 21;
    DocumentQuery view_query = 22;           // 100% TrueAST
    string database_name = 23;
    
    string user_name = 24;
    string password = 25;
    repeated string user_roles = 26;
    string new_name = 27;
    SetOperationClause set_operation = 28;
    repeated Expression columns = 29;         // 100% TrueAST
    repeated SelectColumn select_columns = 30;
    string session_id = 31;
    repeated QueryCondition having = 32;
    bool distinct = 33;
    string query = 34;
}

// ============================================
// âš¡ KEY-VALUE QUERY (Redis)
// ============================================

message KeyValueQuery {
    string command = 1;
    string key = 2;
    repeated string args = 3;
    repeated KeyValuePair bulk_pairs = 4;
    string session_id = 5;
    string command_string = 6;
}

message KeyValuePair {
    string key = 1;
    string value = 2;
}

// ============================================
// ðŸ“Š SUPPORTING STRUCTURES (100% TrueAST)
// ============================================

message JoinClause {
    string join_type = 1;         // INNER, LEFT, RIGHT, FULL, CROSS
    string table = 2;
    Expression left_expr = 3;     // 100% TrueAST
    Expression right_expr = 4;    // 100% TrueAST
    int32 position = 5;
}

message AggregateClause {
    string function = 1;          // COUNT, SUM, AVG, MIN, MAX
    Expression field_expr = 2;    // 100% TrueAST
    int32 position = 3;
}

message OrderByClause {
    Expression field_expr = 1;    // 100% TrueAST
    string direction = 2;         // ASC, DESC
    int32 position = 3;
}

message WindowClause {
    string function = 1;                    // ROW NUMBER, RANK, etc.
    Expression field_expr = 2;              // 100% TrueAST
    string alias = 3;
    repeated Expression partition_by = 4;   // 100% TrueAST
    repeated OrderByClause order_by = 5;
    int32 offset = 6;
    int32 buckets = 7;
    int32 position = 8;
}

message CTEClause {
    string cte_name = 1;
    RelationalQuery cte_query = 2;          // 100% TrueAST
    bool recursive = 3;
    repeated CTEClause additional_ctes = 4;
}

message SubqueryClause {
    string subquery_type = 1;               // IN, EXISTS, NOT_IN, NOT_EXISTS, SCALAR
    Expression field_expr = 2;              // 100% TrueAST
    RelationalQuery subquery = 3;           // 100% TrueAST
    string alias = 4;
}

message UpsertClause {
    repeated Expression conflict_fields = 1; // 100% TrueAST
    repeated QueryField update_fields = 2;
    string conflict_action = 3;
}

message BulkInsertRow {
    repeated QueryField fields = 1;
}

message SetOperationClause {
    string operation_type = 1;              // UNION, UNION ALL, INTERSECT, EXCEPT
    RelationalQuery left_query = 2;
    RelationalQuery right_query = 3;
}